---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Quiz, Song } from "../../types/quiz";

export async function getStaticPaths() {
    const modules = import.meta.glob("../../../data/quizzes/quiz_*.json", {
        eager: true,
    }) as Record<string, { default: Quiz }>;

    return Object.values(modules).map((m) => ({
        params: { id: `${m.default.quiz_no}${m.default.group}` },
        props: { quiz: m.default },
    }));
}

const { quiz } = Astro.props as { quiz: Quiz };

const songModules = import.meta.glob("../../../data/songs/*.json", {
    eager: true,
}) as Record<string, { default: Song }>;

const songs = Object.values(songModules).map((m) => m.default);
---

<BaseLayout title={`第${quiz.quiz_no}${quiz.group}回`}>
    <h1>第{quiz.quiz_no}{quiz.group}回</h1>
    <p>{quiz.date}</p>

    {
        quiz.songs.map((qs) => {
            const song = songs.find((s) => s.contentId === qs.contentId);
            const winner = qs.answers.find(
                (a) => a.result === "OK" || a.result === "WIN",
            );

            return (
                <section>
                    <h2>
                        {qs.order}.{" "}
                        <a href={`/songs/${qs.contentId}`}>
                            {song?.song ?? qs.contentId}
                        </a>
                    </h2>

                    <p>
                        結果：
                        {winner ? (
                            <a href={`/users/${winner.user}`}>{winner.user}</a>
                        ) : (
                            "SKIP"
                        )}
                    </p>

                    <ul>
                        {qs.answers.map((a) => (
                            <li>
                                [{a.result}]{" "}
                                {a.user && (
                                    <a href={`/users/${a.user}`}>{a.user}</a>
                                )}
                            </li>
                        ))}
                    </ul>
                </section>
            );
        })
    }
</BaseLayout>
