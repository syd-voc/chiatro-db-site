---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Quiz } from "../../types/quiz";

/* =========
   曲マスタを全取得
========= */
type Song = {
    videoId: string;
    title: string;
    artist?: string;
};

const songModules = import.meta.glob("../../../data/songs/*.json", {
    eager: true,
}) as Record<string, { default: Song }>;

/* =========
   クイズログを全取得
========= */
const quizModules = import.meta.glob("../../../data/quizzes/quiz_*.json", {
    eager: true,
}) as Record<string, { default: Quiz }>;

/* =========
   静的パス生成
========= */
export async function getStaticPaths() {
    const songs = Object.values(songModules).map((m) => m.default);

    return songs.map((song) => ({
        params: { videoId: song.videoId },
        props: { song },
    }));
}

/* =========
   props
========= */
const { song } = Astro.props as { song: Song };

/* =========
   この曲が出題されたクイズを逆引き
========= */
const quizzes: Quiz[] = Object.values(quizModules).map((m) => m.default);

const appearances = quizzes.flatMap((quiz) =>
    quiz.songs
        .filter((s) => s.videoId === song.videoId)
        .map((s) => ({
            quizId: quiz.quizId,
            date: quiz.date,
            order: s.order,
            answers: s.answers,
        })),
);
---

<BaseLayout title={`${song.title}`}>
    <h1>{song.title}</h1>

    {song.artist && <p>作者：{song.artist}</p>}
    <p>動画ID：{song.videoId}</p>

    <h2>出題履歴</h2>

    {
        appearances.length === 0 ? (
            <p>この曲はまだ出題されていません。</p>
        ) : (
            <ul>
                {appearances.map((a) => (
                    <li>
                        <a href={`/quizzes/${a.quizId}`}>第{a.quizId}回</a>（
                        {a.date}） / {a.order}曲目
                    </li>
                ))}
            </ul>
        )
    }
</BaseLayout>
