---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Quiz, Song } from "../../types/quiz";

/* =========================
   静的パス生成
========================= */
export async function getStaticPaths() {
    const songModules = import.meta.glob("../../../data/songs/*.json", {
        eager: true,
    }) as Record<string, { default: Song }>;

    const artistSet = new Set<string>();

    Object.values(songModules).forEach((m) => {
        m.default.artist.forEach((a) => artistSet.add(a));
    });

    return Array.from(artistSet).map((artist) => ({
        params: { artist },
    }));
}

/* =========================
   データ読み込み
========================= */
const { artist } = Astro.params;

// 曲
const songModules = import.meta.glob("../../../data/songs/*.json", {
    eager: true,
}) as Record<string, { default: Song }>;

const allSongs = Object.values(songModules).map((m) => m.default);

const songs = allSongs.filter((s) => s.artist.includes(artist));

// クイズ
const quizModules = import.meta.glob("../../../data/quizzes/quiz_*.json", {
    eager: true,
}) as Record<string, { default: Quiz }>;

const quizzes = Object.values(quizModules).map((m) => m.default);

const artistSongIds = new Set(songs.map((s) => s.contentId));

const userCorrectMap = new Map<string, number>();

quizzes.forEach((quiz) => {
    quiz.songs.forEach((song) => {
        if (!artistSongIds.has(song.contentId)) return;

        song.answers.forEach((a) => {
            if (a.result === "OK" || a.result === "WIN") {
                userCorrectMap.set(
                    a.user,
                    (userCorrectMap.get(a.user) ?? 0) + 1,
                );
            }
        });
    });
});

const topUsers = Array.from(userCorrectMap.entries())
    .map(([user, count]) => ({ user, count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 10);

/* =========================
   曲ごとの出題回数集計
========================= */
const songStats = songs.map((song) => {
    const appearances = quizzes.flatMap((q) =>
        q.songs.filter((s) => s.contentId === song.contentId),
    );

    return {
        contentId: song.contentId,
        title: song.song,
        count: appearances.length,
        startTime: song.startTime ?? null,
    };
});

// デフォルト：出題回数多い順
songStats.sort((a, b) => b.count - a.count);

function formatDateTime(iso?: string) {
    if (!iso) return "―";
    const d = new Date(iso);
    return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(
        2,
        "0",
    )}/${String(d.getDate()).padStart(2, "0")} ${String(d.getHours()).padStart(
        2,
        "0",
    )}:${String(d.getMinutes()).padStart(2, "0")}`;
}
---

<BaseLayout title={`アーティスト：${artist}`}>
    <h1>アーティスト：{artist}</h1>

    <section>
        <h2>楽曲一覧（{songStats.length} 曲）</h2>

        <table class="song-table">
            <thead>
                <tr>
                    <th role="button" tabindex="0" data-sort-key="title">
                        曲名
                        <span class="sort-icon"></span>
                    </th>
                    <th role="button" tabindex="0" data-sort-key="startTime">
                        投稿日時
                        <span class="sort-icon"></span>
                    </th>
                    <th role="button" tabindex="0" data-sort-key="count">
                        出題回数
                        <span class="sort-icon"></span>
                    </th>
                </tr>
            </thead>
            <tbody id="song-table-body">
                {
                    songStats.map((s) => (
                        <tr
                            data-title={s.title}
                            data-count={s.count}
                            data-start-time={s.startTime ?? ""}
                        >
                            <td>
                                <a href={`/songs/${s.contentId}`}>{s.title}</a>
                            </td>
                            <td>
                                {s.startTime
                                    ? (() => {
                                          const d = new Date(s.startTime);
                                          const yyyy = d.getFullYear();
                                          const mm = String(
                                              d.getMonth() + 1,
                                          ).padStart(2, "0");
                                          const dd = String(
                                              d.getDate(),
                                          ).padStart(2, "0");
                                          const hh = String(
                                              d.getHours(),
                                          ).padStart(2, "0");
                                          const min = String(
                                              d.getMinutes(),
                                          ).padStart(2, "0");
                                          return `${yyyy}/${mm}/${dd} ${hh}:${min}`;
                                      })()
                                    : "―"}
                            </td>
                            <td>{s.count}</td>
                        </tr>
                    ))
                }
            </tbody>
        </table>
    </section>

    <section>
        <h2>正解数 TOP10</h2>

        {
            topUsers.length === 0 ? (
                <p>正解者がまだいません。</p>
            ) : (
                <table>
                    <thead>
                        <tr>
                            <th>ユーザー</th>
                            <th class="count">正解数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {topUsers.map((u) => (
                            <tr>
                                <td>
                                    <a href={`/users/${u.user}`}>{u.user}</a>
                                </td>
                                <td class="count">{u.count}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            )
        }
    </section>
</BaseLayout>

<script is:inline>
    const tbody = document.getElementById("song-table-body");
    const rows = Array.from(tbody.children);
    const headers = document.querySelectorAll("th[data-sort-key]");

    let currentSort = {
        key: "count",
        asc: false,
    };

    function updateIcons(activeKey) {
        headers.forEach((th) => {
            th.removeAttribute("data-sort-state");
            if (th.dataset.sortKey === activeKey) {
                th.setAttribute(
                    "data-sort-state",
                    currentSort.asc ? "asc" : "desc",
                );
            }
        });
    }

    function sortRows(key) {
        if (currentSort.key === key) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.key = key;
            // 投稿日・出題回数は新しい順が自然
            currentSort.asc = key === "title";
        }

        const sorted = [...rows].sort((a, b) => {
            if (key === "title") {
                const res = a.dataset.title.localeCompare(
                    b.dataset.title,
                    "ja",
                );
                return currentSort.asc ? res : -res;
            }

            if (key === "count") {
                const res = Number(a.dataset.count) - Number(b.dataset.count);
                return currentSort.asc ? res : -res;
            }

            if (key === "startTime") {
                const ta = a.dataset.startTime;
                const tb = b.dataset.startTime;

                // 不明は常に最後
                if (!ta && !tb) return 0;
                if (!ta) return 1;
                if (!tb) return -1;

                const res = new Date(ta).getTime() - new Date(tb).getTime();
                return currentSort.asc ? res : -res;
            }

            return 0;
        });

        sorted.forEach((row) => tbody.appendChild(row));
        updateIcons(key);
    }

    headers.forEach((th) => {
        th.addEventListener("click", () => {
            sortRows(th.dataset.sortKey);
        });

        th.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                sortRows(th.dataset.sortKey);
            }
        });
    });

    // 初期状態：出題回数 多い順
    updateIcons("count");
</script>
